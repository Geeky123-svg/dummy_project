{% extends "user.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-2 text-primary">Quiz Performance: {{ quiz.title }}</h2>
    <h4 class="mb-4 text-secondary">Chapter: {{ quiz.chapter.name }}</h4>
    <a href="{{ url_for('user_bp.previous_scores') }}" class="btn btn-dark mb-4">← Back to Scores</a>

    <div class="row mb-4 align-items-center">
        
        <div class="col-md-6 d-flex justify-content-center">
            <div style="max-width: 300px; max-height: 300px;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="alert alert-info text-center">
                <h4 class="mb-0">
                    Your Score: <strong>{{ user_score.total_score }} / {{ questions|length }}</strong>
                </h4>
                <small>Attempted on: {{ user_score.time_stamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
            </div>
        </div>
        
    </div>
    <ul class="list-group">
        {% for question in questions %}
            {% set user_selection_key = user_answers.get(question.id) %}
            
            {% set options = {
                "A": question.option1,
                "B": question.option2,
                "C": question.option3,
                "D": question.option4
            } %}

            <li class="list-group-item mt-3 shadow-sm 
                {% if user_selection_key == question.correct_option %} list-group-item-success
                {% elif user_selection_key is not none %} list-group-item-danger
                {% else %} list-group-item-secondary
                {% endif %}">
                
                <p class="mb-2">
                    <strong>Q{{ loop.index }}:</strong> {{ question.question_statement }}
                    <span class="badge bg-secondary float-end">{{ question.difficulty|capitalize }}</span>
                </p>
                
                <hr class="my-1">

                <ul class="list-unstyled mb-0">
                    {% for key, value in options.items() %}
                        <li class="py-1 
                            {% if key == question.correct_option %} text-success fw-bold
                            {% elif key == user_selection_key %} text-danger fw-bold
                            {% endif %}">
                            
                            {{ key }}. {{ value }} 
                            
                            {% if key == question.correct_option %}
                                <span class="float-end">✅ Correct Answer</span>
                            {% elif key == user_selection_key %}
                                <span class="float-end">
                                    {% if key == question.correct_option %}
                                        ✅ Your Answer
                                    {% else %}
                                        ❌ Your Answer
                                    {% endif %}
                                </span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>

                <div class="mt-2 pt-2 border-top">
                    {% if user_selection_key is none %}
                        <span class="text-secondary fw-bold">Not Answered</span>
                    {% elif user_selection_key == question.correct_option %}
                        <span class="text-success fw-bold">Result: Correct!</span>
                    {% else %}
                        <span class="text-danger fw-bold">Result: Incorrect!</span>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
    
    <br>
    <a href="{{ url_for('user_bp.previous_scores') }}" class="btn btn-dark mb-4">← Back to Scores</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const correct = {{ correct_count }};
    const incorrect = {{ incorrect_count }};
    const unattempted = {{ unattempted_count }};
    
    if (typeof Chart !== 'undefined') {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [
                    'Correct',
                    'Incorrect',
                    'Not Attempted'
                ],
                datasets: [{
                    data: [correct, incorrect, unattempted],
                    backgroundColor: [
                        '#198754', // Green for Correct (Success)
                        '#dc3545', // Red for Incorrect (Danger)
                        '#6c757d'  // Gray for Not Attempted (Secondary)
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Question Breakdown'
                    }
                }
            }
        });
    } else {
        console.error("Chart.js library is not loaded. Cannot render performance chart.");
    }
</script>

{% endblock %}